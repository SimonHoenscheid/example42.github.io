I"<p>The release of  <a href="https://puppet.com/products/puppet-bolt">bolt</a> at last PuppetConf has stirred a lot of interest in Puppet community and in a very few days modules with tasks have started to appear on the Forge.</p>

<p>At example42 we have started to experiment with Bolt and have added relevant profiles and tasks to the <a href="https://github.com/example42/puppet-psick">psick</a> module.</p>

<p>Let’s see how to work with Bolt in PSICK.</p>

<p>First we need to install the psick module:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puppet module install example42/psick
</code></pre></div></div>

<p>Or add it to the <code class="highlighter-rouge">Puppetfile</code> of our control-repo (we can use the <a href="https://github.com/example42/psick">PSICK control-repo</a> or any other one):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mod 'example42/psick', :latest
</code></pre></div></div>

<p>Then we have to classify our nodes with the psick class, it’s enough something like</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include psick
</code></pre></div></div>

<p>Once the psick class is added to the catalog nothing happens, by default, but a huge amount of functionalities is a parameter away. If we use, as we should, Hiera to manage our data, and we have an [e]yaml backend, we can install bolt on a node (we need it only on the server from which we run commands) with data like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::base::linux_classes:
  bolt: 'psick::bolt'

psick::bolt::is_master: true
</code></pre></div></div>

<p>Psick can also automatically manage ssh keys sharing between nodes and the creation of a bolt user on all the nodes, who can sudo bold commands. This is completely optional (we can connect with bolt directly using the root user and share authorised keys via other methods) but if we want everything done out of the box we can add, for all our nodes:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::base::linux_classes:
  bolt: 'psick::bolt'

psick::bolt::master: &lt;bolt_master&gt; # Bolt master is the fqdn of node where to set psick::bolt::is_master: true
psick::bolt::keyshare_method: storeconfigs
</code></pre></div></div>

<p>We require storeconfigs enabled on our Puppet Server to automatically share ssh keys between the Master and the managed nodes.</p>

<p>It will take some Puppet runs, on the so called Bolt master and the managed nodes, to converge and distribute the ssh keys to use for bolt.</p>

<p>Once done, we can login on the Bolt master, as bolt user and from here we can run via Bolt commands, scripts, tasks and plans on any node of our Puppet infrastructure:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[bolt@puppet ~]$ bolt command run uptime --n $(cat nodes/all) --user bolt
</code></pre></div></div>

<p>Psick creates automatically the file called <code class="highlighter-rouge">nodes/all</code> in the home of the bolt user (this is the default user psick uses for ssh connections both on master and managed nodes), with a csv of all the nodes of the infrastructure.</p>

<p>In the class <code class="highlighter-rouge">psick::bolt::master</code> is possible to create and customise different files for different nodes lists.</p>

<p>The psick module has some tasks too, the first one we’ve thought about when we have heard about Bolt:</p>

<ul>
  <li><code class="highlighter-rouge">psick::puppet_install</code> installs Puppet agent on a remote node</li>
  <li><code class="highlighter-rouge">psick::puppet_agent</code> runs Puppet agent on a remote node (eventually specifying the Puppet master, the Puppet environment and if to run in noop or no-noop mode</li>
  <li><code class="highlighter-rouge">psick::puppet_enable_noop</code> configures noop mode on puppet.conf</li>
  <li><code class="highlighter-rouge">psick::puppet_unlock</code> removes lock files create by stale Puppet runs or by <code class="highlighter-rouge">puppet agent --disable</code></li>
  <li><code class="highlighter-rouge">psick::system_update</code> trigger the update of all packages of the system</li>
</ul>

<p>We are quite sure this list is going to grow and the single tasks to be refined, but we think this list already covers some quite common needs.</p>

<p>To run one of Psick’s tasks:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bolt task run psick::puppet_unlock -n &lt;node_fqdn&gt; --modules &lt;module_path&gt; --user bolt
</code></pre></div></div>

<p>(Note, we don’t have to specify <code class="highlighter-rouge">--user bolt</code> (the one used for SSH login) if we are running as bolt user locally. The examples in this post are done on vagrant servers and for some reasons the vagrant user is used by default to connect to remote servers, even if bolt is run as bolt user.)</p>

<p>To run puppet agent in noop mode using the integration environment on all nodes, a command like this is enough:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bolt task run psick::puppet_agent noop=true environment=integration -n $(cat nodes/all) --modules &lt;module_path&gt; --user bolt
</code></pre></div></div>

<p>If you use psick, you have also the Tiny Puppet module installed, and this brings with it the <code class="highlighter-rouge">tp::test</code> task, which allows quick testing on the status of all the applications managed by Tiny Puppet in the whole infrastructure:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bolt task run tp::test -n $(cat nodes/all) --modules &lt;module_path&gt; --user bolt
</code></pre></div></div>

<p>This is just the beginning of our exploration of Bolt and Puppet tasks (and plans!) in psick.</p>

<p>We see a huge potential in Bolt, it perfectly fits the part where Puppet was weaker than other tools like Ansible: remote commands execution, on demand, and, partly, orchestration.</p>

<p>We are sure a lot of interesting use cases and applications will arise in the near future and we are committed to play a lot with it inside and outside PSICK.</p>

<p>Alessandro Franceschi</p>
:ET