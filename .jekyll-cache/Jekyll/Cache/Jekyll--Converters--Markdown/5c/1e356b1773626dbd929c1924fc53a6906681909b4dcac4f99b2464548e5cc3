I"'<p>The release of Hiera 5, shipped with Puppet 4.9, has introduced several new features.</p>

<p>We have already talked about it in a previous <a href="2017-04-17-hiera-5.md">blog post</a> and now we are going to explore new elements which may be quite interesting and useful in some use cases:  <strong>globs</strong> and <strong>mapped paths</strong>.</p>

<p>We already know that in <code class="highlighter-rouge">hiera.yaml</code>, when using file based backends, we can define hierarchies using 2 similar keys: <strong>path</strong> and <strong>paths</strong>. They are similar as they allow us to specify a path, or an array of paths, where to look for data.</p>

<p>Their usage is something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hierarchy:
  - name: "Per-node data"
    path: "nodes/%{trusted.certname}.yaml"

  - name: "Common data"
    path: "common.yaml"
</code></pre></div></div>

<p>which, when using the <strong>paths</strong> key, is equivalent to :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hierarchy:
  - name: "Hiera data"
    paths:
      - "nodes/%{trusted.certname}.yaml"
      - "common.yaml"
</code></pre></div></div>

<p>This is common and known stuff, more or less we have always used this path based approach to define our hierarchies.</p>

<p>Now we have some more options, more dynamic and evolved ways to define hierarchies and where to look for data files.</p>

<p>One of them is the usage of the <strong>glob</strong> and <strong>globs</strong> keys:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hierarchy:
  - name: "Hiera data"
    glob: "groups/*.yaml"
</code></pre></div></div>

<p>In this case the Hiera lookup is done for <em>each</em> yaml file present in the groups directory, parsed in alphanumerical order. Note that in the above example no variable interpolation is used, but that’s still possible: any fact or variable in the scope can be used in the glob definition.</p>

<p>The Ruby glob method is used to map file paths, so the following rules apply:</p>

<ul>
  <li>With one asterisk (*) we match any character for a single file.</li>
  <li>With two asterisks (**) any depth of nested directories is matched.</li>
  <li>A question mark (?) matches one character.</li>
  <li>Comma-separated lists in curly braces ({admins,dba}) match any option in the list.</li>
  <li>Sets of characters in square brackets ([abcd]) match any character in the set.</li>
  <li>A backslash () escapes special characters.</li>
</ul>

<p>Using <code class="highlighter-rouge">globs</code> instead of <code class="highlighter-rouge">glob</code> allows us to specify an array of glob patterns, the same logic of <code class="highlighter-rouge">paths</code> and <code class="highlighter-rouge">path</code>.</p>

<p>I’m still trying to figure out good use cases for glob, considering that I don’t personally like long or complex hierarchies.</p>

<p>Maybe this could be useful for cases where we want to have different users (or machines) to edit independently different files, or when we want to define the parameters for our classes in different places, for sake of order or simplicity.</p>

<p>For example it could be useful to split a file like <a href="https://github.com/example42/psick/blob/production/site/profile/data/common.yaml">this</a> in different files, eventually one of each class / profile.</p>

<p>Another interesting way to define hierarchies is by using <strong>mapped paths</strong> key.</p>

<p>An example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Applications
  mapped_paths: [apps, app, "apps/%{app}.yaml"]
</code></pre></div></div>

<p>The mapped_paths key must have an array as argument with three string elements, in the following order:</p>
<ul>
  <li>A variable whose value is an array or hash (<code class="highlighter-rouge">apps</code> in the example)</li>
  <li>A temporary variable name to represent each element of the array or hash. This variable name, (<code class="highlighter-rouge">app</code> in the example), is used only in the path in this key.</li>
  <li>A path where that temporary variable can be used in interpolation expressions.</li>
</ul>

<p>With the above example if we had a <code class="highlighter-rouge">$apps</code> variable containing an array like <code class="highlighter-rouge">['fe','be','db']</code> Hiera would lookup for data in the following files (relative to the defined <code class="highlighter-rouge">datadir</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apps/fe.yaml
apps/be.yaml
apps/db.yaml
</code></pre></div></div>

<p>What’s the use case for mapped paths?</p>

<p>One typical (?) case is when we want to assign to a node one or more <em>roles</em>.  Usual practice is to have a role and only a role for each node, but in some cases the concept of role has slightly different nuances and we may want to be able to have more than one role (or equivalent concept) in a node.</p>

<p>With the good old <code class="highlighter-rouge">path</code> key we imply that for each variable used in the hierarchy there can be only one possible value at a time for a node, and that’s the value used to identify the path of the file with our data.</p>

<p>Both globs and mapped_paths allow far more flexible hierarchies, with data which may be looked, in the same hierarchy, in different files according to values of variables (with <code class="highlighter-rouge">mapped_paths</code>) or more general wild card or regexp based matches (with <code class="highlighter-rouge">globs</code> and <code class="highlighter-rouge">glob</code>).</p>

<p>Having more options is hardly a negative thing, with Hiera 5 a remarkable new spectrum of alternatives is available for more complex, dynamic and flexible data storing and handling.  It’s up to us to understand if we actually need them, but it’s definitively useful to know the possible alternatives, as in some cases they can make our Puppet life better.</p>

<p>Alessandro Franceschi</p>
:ET