I"2<p>How often do you reinstantiate your Puppet server infrastructure?
How often do you upgrade your Puppet master and the agents?</p>

<p>Usually people set up the heart of their Puppet infrastructure in a manual way.</p>

<p>From our perspective this is an anti pattern when you manually manage the core of your automation.
We believe that automating your automation allows you:</p>
<ul>
  <li>to better re-deploy your Puppet infrastructure</li>
  <li>to manage your Puppet infrastructure by using Puppet</li>
  <li>gain confidence that you can easily spin up everything from scratch after major outage</li>
</ul>

<p>The example42 PSICK control-repo now allows you to spin up either Puppet Enterprise or Puppet Open Source infrastructures in a fully automated way.</p>

<p>Getting started with PSICK to automate your Puppet Open Source Server setup on a bare OS installation</p>

<ol>
  <li>
    <p>Get the code base:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> mkdir -p /etc/puppetlabs/code/environment/
 git clone https://github.com/example42/psick /etc/puppetlabs/code/environments/production
 cd /etc/puppetlabs/code/environments/production
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install Puppet 4:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> bin/puppet_install.sh
</code></pre></div>    </div>
  </li>
</ol>

<p>This installs Puppet 4 from Puppet Inc. repositories.</p>

<ol>
  <li>
    <p>Prepare your Puppet</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> bin/puppet_setup.sh
</code></pre></div>    </div>
  </li>
</ol>

<p>Installs required gems and fetches remote modules with r10k.
The list of modules can be modified in <code class="highlighter-rouge">Puppetfile</code>.</p>

<ol>
  <li>Understanding classifying your nodes</li>
</ol>

<p>There are two possible options for node classification:</p>

<p>Option 1: using hiera data
Option 2: using trusted facts</p>

<p>Option 1 is enabled in <code class="highlighter-rouge">manifests/site.pp</code> per default.
Option 2 is available, but deactivated</p>

<p>Our intention is to make use of profiles within hiera for node classification.
Adding roles on top of profiles adds another layer of complexity which mostly is not required.
Profiles usually are parameterized classes which can fetch data from hiera using automatic data binding.</p>

<ol>
  <li>Classify your master</li>
</ol>

<p>Adopt settings from hieradata/nodes/puppet.foss.psick.io.yaml</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># hieradata/nodes/&lt;master fqdn&gt;.yaml
---
profiles:
  - profile::puppet::gems
  - profile::puppet::foss_server
profile::puppet::gems::install_puppetserver_gems: true
</code></pre></div></div>

<ol>
  <li>
    <p>run puppet to automate the Master setup</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> bin/papply.sh
</code></pre></div>    </div>
  </li>
</ol>

<p>This builds you a fully operational monolithic Puppet master with PuppetDB, storeconfigs and reporting enabled.</p>

<p>But how to get your code improvements onto your fresh Puppet master?</p>

<p>This is where the profile parameters come into place:</p>

<p>The FOSS Puppet master profile allows you to set r10k configurations. At the moment we only support a single r10k repository.
Just add proper namespace keys to hiera:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># hieradata/nodes/&lt;master fqdn&gt;.yaml
profile::puppet::foss_master::r10k_remote_repo: 'git@gitlab.foss.psick.io:/repos/psick.git'
</code></pre></div></div>

<p>You can either specify this setting prior running step 5 or add the setting later and run puppet agent.</p>

<p>Summary for automated Puppet Open Source installation</p>

<ol>
  <li>add node classification information to hiera</li>
  <li>place the repo on the new Puppet master</li>
  <li>bin/puppet_install.sh</li>
  <li>bin/puppet/setup.sh</li>
  <li>bin/papply.sh</li>
</ol>

<p>Martin Alfke</p>
:ET