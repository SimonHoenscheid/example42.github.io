I"<p>We continue our review of psick profiles describing how <code class="highlighter-rouge">psick::users</code> can help in configuring users, root password, sudo and ssh keys.</p>

<p>This comes after:</p>

<ul>
  <li>
    <p><a href="https://www.example42.com/2018/11/12/psick_profiles_part_1_overview/" target="_blank">Part 1 - Overview</a> of the psick module and its reusable profiles.</p>
  </li>
  <li>
    <p><a href="https://www.example42.com/2018/11/19/psick_profiles_part_2_proxy_and_hostname_settings/" target="_blank">Part 2 - Proxy and Hostname</a> settings with psick profiles.</p>
  </li>
  <li>
    <p><a href="https://www.example42.com/2018/12/03/psick_profiles_part_3_openssh/" target="_blank">Part 3 - OpenSSH</a> settings, keys, configs management.</p>
  </li>
</ul>

<p>For the following configuation we just need to classify for <code class="highlighter-rouge">psick::users</code> class:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include psick::users
</code></pre></div></div>

<p>As usual the following hiera sample parameters are expressed in yaml format.</p>

<h2 id="managing-root-user">Managing root user</h2>

<p>We can set password of root user with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::root_pw: '$6$OkmG4mu/$RbyL'
</code></pre></div></div>

<p>The value is passed as password argument for the user root, in whatever encrypted format the local system requires.</p>

<p>It’s possible to configure any other argumente of the root user with the parameter root_params:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::root_params:
  comment: 'Root user'
  shell: '/bin/bash'
</code></pre></div></div>

<h2 id="managing-all-users">Managing all users</h2>

<p>For all the other users there’s the <code class="highlighter-rouge">users_hash</code> parameter, looked up in deep merge mode (as any parameter of psick classes whose name ends with _hash), which allows to define one or more users with the relevant set or arguments.</p>

<p>This is not just a wrapper around the user resource type, as we can use component modules as “backends”.</p>

<p>This is managed via the <code class="highlighter-rouge">psick::users::module</code> parameter which define which module to use to manage users:</p>
<ul>
  <li>‘user’ to use Puppet native type <code class="highlighter-rouge">user</code></li>
  <li>‘psick’ to use the define <a href="https://github.com/example42/puppet-psick/blob/master/manifests/users/managed.pp"><code class="highlighter-rouge">psick::users::managed</code></a></li>
  <li>‘accounts’ to use <a href="https://github.com/puppetlabs/puppetlabs-accounts/blob/master/manifests/user.pp"><code class="highlighter-rouge">accounts::user</code></a> from puppetlabs-accounts module</li>
</ul>

<p>So for example we can manage our users, using Puppet native type user, with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::module: 'user'
psick::users::users_hash:
  al:
    ensure: present
    comment: 'Al'
    groups:
      - users
  ma:
    ensure: present
    comment: 'Ma'
    groups:
      - users
</code></pre></div></div>

<p>In the above example the users “al” and “ma” are created, the parameters specified in the hash must be compatible with resource provided by the selected module, otherwise you get an Unknown Argument error.</p>

<p>### Managing extra users resources</p>

<p>In the users hash, besides the arguments acceptable by the selected module define, we can set other special parameters to manage resources for users:</p>

<ul>
  <li>ssh_authorized_keys: An array of keys to add to the user’ authorized keys</li>
  <li>openssh_keygen: A boolean, if true a ssh key pair is automatically generated for the user using the <code class="highlighter-rouge">psick::openssh::keygen</code> define <a href="https://github.com/example42/puppet-psick/blob/master/manifests/openssh/keygen.pp">check here the available parameters</a></li>
  <li>
    <p>sudo_template: The path as used by the template() function of an erb template to use to manage the user’s sudo file. Nothing is created if not defined.</p>

    <p>psick::users::users_hash:
    al:
      ensure: present
      ssh_authorized_keys:
        - ‘ssh-rsa AAAAB3BAQC93uOkdIr…’
      sudo_template: ‘profile/users/sudo/admins’
    jenkins:
      openssh_keygen: true</p>
  </li>
</ul>

<h3 id="purge-unmanaged-users">Purge unmanaged users</h3>

<p>By default Puppet only manages the resources we instruct it to manage, and the same is done with users here. Still there are cases where we want full control on the interactive users managed on a server, this can be accomplished with the (quite dangerous) parameter:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::delete_unmanaged: true
</code></pre></div></div>

<p>The default is false, but is this is the to true all non system users not managed by Puppet are automatically deleted.</p>

<h2 id="managing-etcskel">Managing /etc/skel</h2>

<p>The /etc/skel directory on a Linux systems contains files that are added to the homes of all the users created on the system. We can manage its content with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::source: 'puppet:///modules/profile/users/skel'
</code></pre></div></div>

<p>The contents of the directory specified as source (used as in the file resource type so, in the above sample, on a local profile module, under the <code class="highlighter-rouge">files/users/skel</code> directory) are copied to the system’s /etc/skel directory.</p>

<p>Note that files from here are copied to only to newly created users, so changes here don’t affect the home of existing users.</p>

<h2 id="alternative-way-to-define-users">Alternative way to define users</h2>

<p>If a single hash becomes hard to manage via hiera, due to different users to be applied to different kind of servers, we can have an alternative way to define the users we want to configure on a system.</p>

<p>Alternatively (or complementarily) to <code class="highlighter-rouge">users_hash</code> we have the key <code class="highlighter-rouge">available_users_hash</code> which acts exactly in the same way, but rather than actually creating the users, it can serve as key to define all the possible users we want to manage. The actual users to create are then defined by the <code class="highlighter-rouge">available_users_to_add</code> array.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::users::available_users_hash:
  al:
    ensure: present [...]
  ma:
    ensure: present [...]
  jenkins:
    ensure: present [...]
psick::users::available_users_to_add:
  - al
  - ma
</code></pre></div></div>

<p>In this way we can define all our users in a single Hiera layer, and then use the  <code class="highlighter-rouge">available_users_to_add</code> parameter on the different Hiera hierarchies, to actually manage which users are created where.</p>

<p>This is what can be done for users with <code class="highlighter-rouge">psick::users</code> profile.</p>

<p>Have fun with Puppet, Life, Universe and Everything.</p>

<p>Alessandro Franceschi</p>
:ET