I"æ<p>Puppet 4 has some new functionality. Within the next few blog posts I will give some examples on how to use the new functionality.</p>

<p>The <a href="http://www.example42.com/2015/09/09/puppet4-examples-data-types/">first post</a> covered the new Data Type system.</p>

<p>The <a href="http://www.example42.com/2015/10/07/puppet4-examples-functions/">second post</a> covered the new function API.</p>

<p>This third post covers the new EPP template engine and the HEREDOC implementation.</p>

<p>In Puppet 3 all templates were written as ERB (embedded Ruby) templates.</p>

<p>All variables in ERB templates have either been looked up dynamically, or one needed to specify the scope for variable lookup.</p>

<p>In Puppet 4 a new template engine was introduced: EPP (embedded Puppet).</p>

<p>Within EPP templates varaibles are writtenin Puppet syntax - which means that variables can be specified by using the module/class namespace.</p>

<p>Example (sshd_config):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% if $ssh::port -%&gt;
Port &lt;%= $ssh::port %&gt;
&lt;% else -%&gt;
Port 22
&lt;% end -%&gt;
&lt;% if $ssh::listen -%&gt;
ListenAddress &lt;%= $ssh::listen %&gt;
&lt;% else -%&gt;
ListenAddress 0.0.0.0
ListenAddress ::
&lt;% end -%&gt;
</code></pre></div></div>

<p>Besides this the array iteration also needs to be written in Puppet DSL code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% if $ssh::port ~= Array -%&gt;
&lt;% $ssh::port.each |$port| { -%&gt;
Port &lt;%= $port %&gt;
&lt;% } -%&gt;
&lt;% end -%&gt;
</code></pre></div></div>

<p>Additionally the EPP template now offers the possibility to make use of parameters (like parameterized classes).
Parameters in EPP have to be put in the beginning and are enclosed in EPP tag and a pipe sign.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;% |  String $text, $Array $array, Boolean $bool |&gt;
&lt;% if $string -%&gt;
Text from variable: &lt;%= $string %&gt;
&lt;% end -%&gt;
&lt;% if $array -%&gt;
&lt;% $array.each |$element| { -%&gt;
Array item: &lt;%= $element %&gt;
&lt;% } -%&gt;
&lt;% end -%&gt;
&lt;% if $bool -%&gt;
Bool value is true
&lt;% end -%&gt;
</code></pre></div></div>

<p>Data for EPP parameters are set by the epp or inline_epp function. This function now can have two parameters:</p>

<ol>
  <li>the content of the template (either as file or as variable</li>
  <li>a hashmap for parameters</li>
</ol>

<p>Example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content =&gt; epp('test/example.epp', { text =&gt; 'foo', array =&gt; ['one', 'two'], bool =&gt; false }),
</code></pre></div></div>

<p>Parameterized templates are useful when the template serves different puprposes for different modules. The non parameterized template should be used when only used by one specific module.</p>

<p>===
HEREDOC</p>

<p>It has always been a pain having small config files in Puppet DSL - mostly due to having bad readable code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class my_motd {
  $content = "Welcome to &lt;%= @fqdn %&gt;
This system is managed by Puppet.
Changes will be overwritten on next Puppet Agent run."

  file { '/etc/motd':
    ensure  =&gt; file,
    content =&gt; inline_template($content),
  }
}
</code></pre></div></div>

<p>In Puppet 4 we have a new way of having files being part of the code: HEREDOC.
First, letâ€™s migrate the example to heredoc and epp.</p>

<p>Hereddoc needs a tag (set in round brackets) - like Shell heredoc</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class my_motd {
  $content = @(EOF)
Welcome to &lt;%= $::fqdn %&gt;
This system is managed by Puppet.
Changes will be overwritten on next Puppet Agent run.
EOF

  file { '/etc/motd':
    ensure  =&gt; file,
    content =&gt; inline_epp($content)
  }
}
</code></pre></div></div>

<p>Next we will make use of the fixed identation by using a pipe sign:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class my_motd {
  $content = @(EOF)
    Welcome to &lt;%= $::fqdn %&gt;
    This system is managed by Puppet.
    Changes will be overwritten on next Puppet Agent run.
    | EOF
 
  file { '/etc/motd':
    ensure  =&gt; file,
    content =&gt; inline_epp($content),
  }
}
</code></pre></div></div>

<p>Now we want to make use of the heredoc substitution. Substitution can be enabled by putting the tag in double quotes:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class my_motd {
  $content = @("EOF")
    Welcome to ${::fqdn)
    THis system is managed by Puppet.
    Changes will be overwritten on next Puppet Agent run.
    | EOF
  
  file { '/etc/motd':
    ensure  =&gt; file,
    content =&gt; $content,
  }
}
</code></pre></div></div>

<p>if you need escape sequences then you need to enable them at the heredoc tag:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$content = @(EOF\tn)
</code></pre></div></div>

<p>THis enables tabular and newline escape sequences.</p>

<p>The next posting will deal with several ways on how to upgrade to Puppet 4.</p>
:ET