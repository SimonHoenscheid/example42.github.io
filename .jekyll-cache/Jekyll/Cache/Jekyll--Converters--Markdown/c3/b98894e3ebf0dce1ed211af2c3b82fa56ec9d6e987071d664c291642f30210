I"R<p>Puppet ships natively with some providers to manage the package type on MacOS X:</p>

<ul>
  <li>
    <p>The <code class="highlighter-rouge">macports</code> provider supports installation of packages via <a href="https://www.macports.org">MacPorts</a>.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">appdmg</code> and <code class="highlighter-rouge">apple</code> and <code class="highlighter-rouge">pkgdmg</code> providers use <code class="highlighter-rouge">/usr/bin/hdiutil</code> and <code class="highlighter-rouge">/usr/sbin/installer</code> to mount DMG disk images and installs the included applications. Generally we need to specify the source from where to get the dmg files.</p>
  </li>
</ul>

<p>Besides the App Store, Mac OS has not a native repository and package managers, and this makes it harder to automate the installation of software without specifying from where to get it. But we live in interesting and fecond times and Open Source third party tools can do the job. One of the most complete, popular and interesting package managers is <a href="https://brew.sh">Homebrew</a>.</p>

<p>Homebrew, with its big list of <a href="https://github.com/Homebrew/homebrew-core/tree/master/Formula">formulas</a> allows easy installation of many OSS programs, but it’s thanks to extensions like <a href="https://github.com/Homebrew/homebrew-cask">homebrew-cask</a> that becomes useful to manage common desktop applications (Like Atom, Chrome, Parallels and <a href="https://github.com/Homebrew/homebrew-cask/tree/master/Casks">many more</a>).</p>

<p>Needless to say that in Puppet’s huge modules landscape we have modules that allows installation of HomeBrew, and, more important, ship with dedicated package providers also for Cask.</p>

<p>In particular we tested <a href="https://github.com/TheKevJames/puppet-homebrew">thekevjames-homebrew</a> which is one of the most promising fork of the original Kelsey Hightower module. It provides 3 different providers to manage packages with the brew command:</p>

<ul>
  <li>
    <p>The provider <code class="highlighter-rouge">brew</code> installs packages using <code class="highlighter-rouge">brew install &lt;module&gt;</code> without using brewcask.</p>
  </li>
  <li>
    <p>The provider <code class="highlighter-rouge">brewcask</code> installs packages using <code class="highlighter-rouge">brew cask install &lt;module&gt;</code> so looks in available casks.</p>
  </li>
  <li>
    <p>The provider <code class="highlighter-rouge">homebrew</code> attempts to install packages using first brew and then, on failure, brewcask. This is probably the sanest to use in most of the cases.</p>
  </li>
</ul>

<p>We just need to have the homebrew module in our Puppet’s modulepath and specify one of them when declaring the packages we want to install on Mac.</p>

<p>Puppet code would look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="p">{</span> <span class="s1">'atom'</span><span class="p">:</span>
  <span class="n">provider</span> <span class="p">=&gt;</span> <span class="s1">'homebrew'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>A custom profile which installs Homebrew and has parameters to list the packages to install for a given user could be as simple as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">class</span> <span class="n">profile</span><span class="p">::</span><span class="n">brew</span> <span class="p">(</span>
  <span class="k">String</span> <span class="p">$</span><span class="n">user</span><span class="p">,</span>
  <span class="k">Array</span> <span class="p">$</span><span class="n">packages</span> <span class="p">=</span> <span class="p">[</span> <span class="s1">'docker'</span> <span class="p">,</span> <span class="s1">'virtualbox'</span> <span class="p">,</span> <span class="s1">'firefox'</span> <span class="p">,</span> <span class="s1">'nginx'</span> <span class="p">].</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="p">#</span> <span class="n">Use</span> <span class="n">this</span> 
  <span class="n">class</span> <span class="p">{</span> <span class="s1">'homebrew'</span><span class="p">:</span>
    <span class="n">user</span> <span class="p">=&gt;</span> <span class="p">$</span><span class="n">user</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="p">$</span><span class="n">packages</span><span class="p">.</span><span class="n">each</span> <span class="p">|</span> <span class="p">$</span><span class="n">p</span> <span class="p">|</span> <span class="p">{</span>
     <span class="k">package</span> <span class="p">{</span> <span class="p">$</span><span class="n">p</span><span class="p">:</span>
       <span class="n">provider</span> <span class="p">=&gt;</span> <span class="s1">'homebrew'</span><span class="p">,</span>
       <span class="n">require</span>  <span class="p">=&gt;</span> <span class="n">Class</span><span class="p">[</span><span class="s1">'homebrew'</span><span class="p">],</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you use example42’s psick module you can achive the same using the generic package profile wrapper with this Hiera data:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psick::pre::darwin_classes:
  brew: homebrew
psick::base::darwin_classes:
  packages: psick::packages

psick::packages::resource_default_arguments:
  provider: homebrew
 
psick::packages::packages_list:
  - docker
  - firefox
  - little-snitch
  - parallels
  - atom
</code></pre></div></div>

<p>Installing packages via Puppet on MacOsX, opening the path of Puppet management both of Mac servers and clients has never been so simple!</p>

<p>Alessandro Franceschi</p>
:ET