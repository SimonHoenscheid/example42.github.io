I"´<p>A Puppet control-repo is usually the place where most of the Puppetteer activities are done.</p>

<p>This is especially true if we keep our Hieradata and local profiles in the control-repo git repository, rather than maintaining them in separated git repos, as external modules.</p>

<p>We always wonder (well, we should) what might be the impact of a change on the control repo on the managed infrastructure.</p>

<p>This might be an issue espectially for who is learning Puppet, Hiera and the local interactions.</p>

<p>Here we try to summarize the possible impacts on changes on different files, underlying that every mileage may vary and referred paths ultimately depend on how we structure our code and data in the control-repo.</p>

<p>We define 4 risk levels:</p>

<ul>
  <li>[SAFE] Changes done here are totally safe in terms of impact on running servers (or generally any Puppet managed system)</li>
  <li>[LIMITED] Changes here impact a limited number of servers or not critical elements</li>
  <li>[WARNING] Changes may impact several servers and should be considered with care</li>
  <li>[DANGER] Changes may have a very large impact. Be sure to be aware of what we are doing</li>
</ul>

<p>Letâ€™s review what level of risk may be associated to changes on the different control-repo files.</p>

<p>Needless to say that they refer to actual changes in Puppet code and data, if we are just adding commentef lines we can be confident that we change wonâ€™t have any effect (unless we change a configuration file on a system which may trigger a service restart).</p>

<p>We assume to have hieradata in the <code class="highlighter-rouge">data/</code> directory and local profiles in <code class="highlighter-rouge">site/profile/</code>.</p>

<ul>
  <li>
    <p>[SAFE] <code class="highlighter-rouge">README.md</code>, <code class="highlighter-rouge">docs/</code>, <code class="highlighter-rouge">LICENSE</code> or any other documentation or general information file. Changes done here wonâ€™t have any impact on our servers</p>
  </li>
  <li>
    <p>[DANGER] <code class="highlighter-rouge">hiera.yaml</code> is the Hiera configuration file for the environment, changes here on the hierarchy or the used backends may affect several systems in more or less unpredictable ways. We should edit it only if we know what we are doing. In case of backend changes or big refactors, server side enforced noop mode is highly recommended.</p>
  </li>
  <li>
    <p>[DANGER] <code class="highlighter-rouge">data/common.yaml</code>, <code class="highlighter-rouge">data/defaults.yaml</code> or any file that contain Hiera data which is used for all the nodes (when not overridden in more specific layers of the hierarchy), so any change here may impact several servers. Be aware.</p>
  </li>
  <li>
    <p>[WARNING] <code class="highlighter-rouge">data/role/$role.yaml</code>, <code class="highlighter-rouge">data/zone/$zone.yaml</code>, <code class="highlighter-rouge">data/env/$env.yaml</code> contains Hiera data which is used for a more or less large group of nodes. The actual path names depends on how is our hierarchy. Itâ€™s recommended here to test at least one node belonging to the affected group, before promoting the change.</p>
  </li>
  <li>
    <p>[LIMITED] <code class="highlighter-rouge">data/nodes/</code> contains Hiera data for specific nodes (again, the actual path may change according to the hierarchy, but there always should be one level matching each node certname. Here we can place nodes specific settings, which are easy to test (directly on the involved node) and have a limited impact (only the node having the name of the file we change).</p>
  </li>
  <li>
    <p>[DANGER] <code class="highlighter-rouge">manifests/site.pp</code> or any other manifest here may impact all the nodes. Handle with care.</p>
  </li>
  <li>
    <p>[WARNING] <code class="highlighter-rouge">Puppetfile</code> contains the list of the modules to add to the control-repo. If we add a new module we wonâ€™t have any effect on nodes until we actually start to use its classes or defines. If we remove a module weâ€™ll break Puppet runs in all the nodes that eventually use it. When we add or remove modules, we may see on our nodes files changing at the first Puppet run: these are due the contents of moduleâ€™s plugins being synced to the clients (pluginsync feature) they are normal and wonâ€™t affect our servers operations. When we change versions of the used modules, we might impact exiting nodes. Versions changes for the used modules should always be tested on each managed OS.</p>
  </li>
  <li>
    <p>[WARNING] <code class="highlighter-rouge">.gitlab-ci.yml</code>, <code class="highlighter-rouge">Jenkinsfile</code>, <code class="highlighter-rouge">.travis.yml</code> define, according to the used tool, how is the CI pipeline to test our code, changing these files, or eventual CI commands used in CI on directories like <code class="highlighter-rouge">bin/</code> or <code class="highlighter-rouge">scripts/</code> may break our CI (and thatâ€™s something that should always have the highest priority for fixing).</p>
  </li>
  <li>
    <p>[WARNING] <code class="highlighter-rouge">site/profile/*</code> here may stay local profiles, templates, files, facts, resource types, data types. Changes to our profiles in  <code class="highlighter-rouge">site/profile/manifests</code> impact all the nodes which classifies them. Changes to <code class="highlighter-rouge">site/profile/files</code> or <code class="highlighter-rouge">site/profile/templates</code> may actually change the contents of configuration files on our managed systems.</p>
  </li>
</ul>

<p>We should not be too much worried about the above dangers and warnings, though, itâ€™s normal in the life of Puppet admin to edit such files.</p>

<p>We have just be aware of the potential impact area of our change and, when we are not fully confident on what we are doing, we should always check our changes in noop mode before actually enforcing them.</p>

<p>Alessandro Franceschi</p>
:ET